---
version: "3"

tasks:
  resources:
    desc: Get allocated resources on all nodes
    cmds:
      - kubectl describe nodes | grep -A 9 -e "^\\s*Allocated resources"
    silent: true

  maintenance:on:
    desc: Set cluster in maintenance mode
    silent: true
    cmds:
      - task: nfs:pause
      - flux suspend kustomization apps postgres
      - kubectl apply -f cluster/apps/databases/postgres/postgres-cluster.yaml

  maintenance:off:
    desc: Turn off maintenance mode
    silent: true
    cmds:
      - kubectl apply -f cluster/apps/databases/postgres/postgres-cluster.yaml
      - flux resume kustomization apps postgres
      - task: nfs:resume

  nfs:pause:
    desc: Pause all Helm Releases that rely on NFS storage
    silent: true
    cmds:
      - flux suspend hr -n media bazarr
      - kubectl scale -n media deploy/bazarr --replicas 0
      - flux suspend hr -n media lidarr
      - kubectl scale -n media deploy/lidarr --replicas 0
      - flux suspend hr -n media radarr
      - kubectl scale -n media deploy/radarr --replicas 0
      - flux suspend hr -n media sonarr
      - kubectl scale -n media deploy/sonarr --replicas 0
      - flux suspend hr -n media sonarr-uhd
      - kubectl scale -n media deploy/sonarr-uhd --replicas 0
      - flux suspend hr -n media sabnzbd
      - kubectl scale -n media deploy/sabnzbd --replicas 0
      - flux suspend hr -n apps nextcloud
      - kubectl scale -n apps deploy/nextcloud --replicas 0
      - flux suspend hr -n default minio
      - kubectl scale -n default deploy/minio --replicas 0

  nfs:resume:
    desc: Resume all Helm Releases that rely on NFS storage
    silent: true
    cmds:
      - flux resume hr -n default minio
      - kubectl scale -n default deploy/minio --replicas 1
      - flux resume hr -n apps nextcloud
      - kubectl scale -n apps deploy/nextcloud --replicas 1
      - flux resume hr -n media sabnzbd
      - kubectl scale -n media deploy/sabnzbd --replicas 1
      - flux resume hr -n media lidarr
      - kubectl scale -n media deploy/lidarr --replicas 1
      - flux resume hr -n media radarr
      - kubectl scale -n media deploy/radarr --replicas 1
      - flux resume hr -n media sonarr
      - kubectl scale -n media deploy/sonarr --replicas 1
      - flux resume hr -n media sonarr-uhd
      - kubectl scale -n media deploy/sonarr-uhd --replicas 1
      - flux resume hr -n media bazarr
      - kubectl scale -n media deploy/bazarr --replicas 1
