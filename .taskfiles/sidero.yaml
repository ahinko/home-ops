---
version: 3

tasks:
  update-cilium:
    desc: Update Cilium quick-install
    cmds:
      - helm repo add cilium https://helm.cilium.io/
      - helm repo update cilium
      - helm template --version 1.11.4 cilium/cilium -f ./kubernetes/management/integrations/cilium-quick-install/values.yaml > ./kubernetes/management/integrations/cilium-quick-install/quick-install.yaml -n kube-system
    silent: true

  prepare-rpi:
    desc: Write Talos image to SSD to be used with Raspberry Pi 4
    silent: true
    cmds:
      - "curl -LO https://github.com/siderolabs/talos/releases/download/v1.0.5/metal-rpi_4-arm64.img.xz && xz -d metal-rpi_4-arm64.img.xz"
      - |
        echo "Path to SSD:"
        read path;
        echo "Writing image to: ${path}";
        sudo dd if=metal-rpi_4-arm64.img of=${path} bs=4m
      - "rm metal-rpi_4-arm64.img"

  upgrade-talos:
    desc: Upgrade Talos on Management cluster
    silent: true
    cmds:
      - talosctl upgrade --stage --force --preserve=true --context sidero --nodes ${SIDERO_ENDPOINT} --image ghcr.io/siderolabs/installer:v1.0.6

  upgrade-sidero:
    desc: Upgrade Sidero on Management cluster
    silent: true
    cmds:
      - clusterctl upgrade plan
      - clusterctl upgrade apply --contract v1beta1
      - echo "It seems like the Sidero controller manager loses the host networking setting on upgrade so don't forget to re-enable it using the sidero:patch-host-networking task if you notice any problems."

  patch-host-networking:
    desc: Patch Sidero to enable host networking
    silent: true
    cmds:
      - 'kubectl patch deploy -n sidero-system sidero-controller-manager --type="json" -p=''[{"op": "add", "path": "/spec/template/spec/hostNetwork", "value": true}]'''

  provision:
    desc: Provision Management cluster
    silent: true
    cmds:
      - ./scripts/provision-sidero.sh
