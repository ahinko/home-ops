---
version: 3

tasks:
  write-eeprom-to-sd:
    desc: Write
    silent: true
    cmds:
      - echo "Use Raspberry Pi Imager"

  write-talos-arm64-to-usb:
    desc: Write Talos image to USB drive to be used with Raspberry Pi 4
    silent: true
    cmds:
      - "curl -LO https://github.com/siderolabs/talos/releases/download/v1.5.0/metal-rpi_4-arm64.img.xz && xz -d metal-rpi_4-arm64.img.xz"
      - |
        echo "Path to USB drive:"
        read path;
        diskutil unmount ${path} || true
        diskutil unmountDisk ${path} || true
        echo "Writing image to: ${path}";
        sudo dd if=metal-rpi_4-arm64.img of=${path} bs=4m
      - "rm metal-rpi_4-arm64.img"

  write-talos-amd64-to-usb:
    desc: Write Talos image to USB drive to be used with Raspberry Pi 4
    silent: true
    cmds:
      - "curl -LO https://github.com/siderolabs/talos/releases/download/v1.5.0/talos-amd64.iso"
      - |
        echo "Path to USB drive:"
        read path;
        diskutil unmount ${path} || true
        diskutil unmountDisk ${path} || true
        echo "Writing image to: ${path}";
        sudo dd if=talos-amd64.iso of=${path} bs=4m && sync
      - "rm talos-amd64.iso"

  update-client-certificate:
    desc: Get an updated version of kubeconfig with updated/rotated certificates
    cmds:
      - talosctl kubeconfig ~/.kube/configs/metal -n 192.168.20.21
      - kubectl config rename-context admin@metal metal
    silent: true

  update-talos-integrations:
    desc: Update manifests to be installed along side Talos
    cmds:
      - kustomize build --enable-helm --load-restrictor LoadRestrictionsNone infrastructure/talos/integrations/kubelet-csr-approver/ --output infrastructure/talos/integrations/kubelet-csr-approver/kubelet-csr-approver.yaml
      - kustomize build --enable-helm --load-restrictor LoadRestrictionsNone infrastructure/talos/integrations/cni/ --output infrastructure/talos/integrations/cni/cilium.yaml
      - rm -rf infrastructure/talos/integrations/kubelet-csr-approver/charts
      - rm -rf infrastructure/talos/integrations/cni/charts
    silent: true

  provision:
    desc: Provision cluster
    silent: true
    cmds:
      - ./infrastructure/talos/provision.sh

  upgrade-talos:
    desc: Upgrade Talos on cluster
    silent: true
    cmds:
      - ./infrastructure/talos/upgrade-talos.sh

  upgrade-k8s:
    desc: Upgrade Kubernetes on cluster
    silent: true
    cmds:
      - ./infrastructure/talos/upgrade-k8s.sh
