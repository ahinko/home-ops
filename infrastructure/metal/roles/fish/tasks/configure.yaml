---
- name: Copy starship config file
  ansible.builtin.template:
    src: starship.toml.j2
    dest: "/home/{{ item.name }}/.config/starship.toml"
    mode: 0644
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
  loop: "{{ users }}"
  when:
    - users is defined
    - users is iterable
    - users | length > 0

- name: Install Fisher
  become: true
  become_user: "{{ item.name }}"
  ansible.builtin.command: type fisher &>/dev/null || curl -sL https://git.io/fisher | source && fisher install jorgebucaran/fisher
  loop: "{{ users }}"
  when:
    - users is defined
    - users is iterable
    - users | length > 0

- name: Install Fisher plugins
  become: true
  become_user: "{{ item.name }}"
  ansible.builtin.command: /bin/fish -c 'fisher install decors/fish-colored-man edc/bass franciscolourenco/done jethrokuan/z jorgebucaran/autopair.fish nickeb96/puffer-fish patrickf3139/fzf.fish'
  loop: "{{ users }}"
  when:
    - users is defined
    - users is iterable
    - users | length > 0

- name: Change the shell to fish
  ansible.builtin.user:
    name: "{{ item.name }}"
    shell: /bin/fish
  loop: "{{ users }}"
  when:
    - users is defined
    - users is iterable
    - users | length > 0
