---
- name: Get USB devices
  tags: always
  ansible.builtin.command: lsusb
  register: lsusb_result
  changed_when: false

- name: Create UPS devices list
  tags: always
  ansible.builtin.set_fact:
    ups_devices: "{{ lsusb_result.stdout_lines | select('match', nut_matcher) | list | sort }}"

- name: UPS devices
  ansible.builtin.debug: var=ups_devices

- name: Create configuration dir for each UPS
  ansible.builtin.file:
    path: "{{ nut_config_dir }}/ups{{ index }}"
    state: directory
    mode: "0644"
  loop: "{{ ups_devices }}"
  loop_control:
    index_var: index

- name: Create nut.conf for each UPS
  ansible.builtin.template:
    src: "templates/nut/nut.conf.j2"
    dest: "{{ nut_config_dir }}/ups{{ index }}/nut.conf"
    mode: "0644"
  loop: "{{ ups_devices }}"
  loop_control:
    index_var: index

- name: Create ups.conf for each UPS
  ansible.builtin.template:
    src: "templates/nut/ups.conf.j2"
    dest: "{{ nut_config_dir }}/ups{{ index }}/ups.conf"
    mode: "0644"
  loop: "{{ ups_devices }}"
  loop_control:
    index_var: index
  vars:
    idx: "{{ index }}"
    device: "{{ item }}"

- name: Create upsd.conf for each UPS
  ansible.builtin.template:
    src: "templates/nut/upsd.conf.j2"
    dest: "{{ nut_config_dir }}/ups{{ index }}/upsd.conf"
    mode: "0644"
  loop: "{{ ups_devices }}"
  loop_control:
    index_var: index

- name: Create upsd.users for each UPS
  ansible.builtin.template:
    src: "templates/nut/upsd.users.j2"
    dest: "{{ nut_config_dir }}/ups{{ index }}/upsd.users"
    mode: "0644"
  loop: "{{ ups_devices }}"
  loop_control:
    index_var: index

- name: Create upsmon.conf for each UPS
  ansible.builtin.template:
    src: "templates/nut/upsmon.conf.j2"
    dest: "{{ nut_config_dir }}/ups{{ index }}/upsmon.conf"
    mode: "0644"
  loop: "{{ ups_devices }}"
  loop_control:
    index_var: index
  vars:
    idx: "{{ index }}"
    device: "{{ item }}"

- name: Generate docker-compose
  ansible.builtin.template:
    src: "templates/docker-compose.yaml.j2"
    dest: "{{ nut_config_dir }}/docker-compose.yaml"
    mode: "0644"
# - name: Start or restart docker containers
# - name: Validation
#   tags: validate
#   block:
#     - name: Validate upsc client returns all UPS devices
#       ansible.builtin.command: upsc -L localhost
#       register: upsc_result
#       changed_when: false
#       failed_when: ups_devices | length != upsc_result.stdout_lines | select('match', '^ups-[0-9]+') | list | length
