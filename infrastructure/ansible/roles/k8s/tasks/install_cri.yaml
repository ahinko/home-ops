---
- name: Install containerd.io
  ansible.builtin.package:
    name: containerd.io
    state: present
    update_cache: true

- name: Create containerd directory
  ansible.builtin.file:
    name: /etc/containerd
    state: directory
    mode: u=rwx,g=rx,o=rx

- name: Check if config.toml is updated
  ansible.builtin.lineinfile:
    path: /etc/containerd/config.toml
    regexp: "^#[grpc]"
    state: absent
  check_mode: true
  changed_when: false
  register: containerd_config

- name: Render containerd default config
  ansible.builtin.shell: containerd config default > /etc/containerd/config.toml
  when:
    - containerd_config.found

- name: Enable SystemdCgroup for containerd
  ansible.builtin.replace:
    path: /etc/containerd/config.toml
    regexp: '^(\s*)SystemdCgroup(.*)$'
    replace: '\1SystemdCgroup = true'
  notify:
    - Reload containerd

- name: Start and enable containerd
  ansible.builtin.systemd:
    name: containerd
    state: started
    enabled: true

- name: Force all notified handlers to run now
  ansible.builtin.meta: flush_handlers
