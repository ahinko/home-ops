---
- name: Onboot - ensure onboot directory exists
  ansible.builtin.raw: mkdir -p "{{ unifi_onboot_directory }}"

- name: Onboot - deploy custom configurations
  delegate_to: localhost
  become: false
  with_items:
    - {file: "files/scripts/00-onboot-sshkeys.sh", enabled: true}
    - {file: "files/scripts/05-onboot-container.sh", enabled: true}
    - {file: "files/scripts/05-onboot-install-cni-plugins.sh", enabled: true}
    - {
      file: "files/scripts/10-onboot-frr.sh",
      enabled: "{{ frr_enabled | bool }}",
    }
    - {
      file: "files/scripts/10-onboot-rsyncd.sh",
      enabled: "{{ rsyncd_enabled | bool }}",
    }
    - {
      file: "files/scripts/10-onboot-nodeexporter.sh",
      enabled: "{{ nodeexporter_enabled | bool }}",
    }
    - {
      file: "files/scripts/10-onboot-haproxy.sh",
      enabled: "{{ haproxy_enabled | bool }}",
    }
  ansible.builtin.raw: "[[ {{ item.enabled }} = 'True' ]] && scp {{ role_path }}/{{ item.file }} {{ ansible_user }}@{{ ansible_host }}:{{ unifi_onboot_directory }}/ || echo 'item disabled: {{ item.file }}'"

- name: Onboot - ensure cni directory exists
  ansible.builtin.raw: mkdir -p "{{ cni_directory }}"

- name: Onboot - deploy cni configurations
  delegate_to: localhost
  become: false
  with_items:
    - {
      file: "files/cni/10-haproxy.conflist",
      enabled: "{{ haproxy_enabled | bool }}",
    }
  ansible.builtin.raw: "[[ {{ item.enabled }} = 'True' ]] && scp {{ role_path }}/{{ item.file }} {{ ansible_user }}@{{ ansible_host }}:{{ cni_directory }}/ || echo 'item disabled: {{ item.file }}'"

- name: Template masquerade nat rules
  when: masquerade_enabled and masquerade_nat_rules is defined
  tags:
    - iprules
  ansible.builtin.raw: 'echo "{{ lookup(''template'', ''masquerade-nat-rules.sh.j2'') }}" > {{ unifi_onboot_directory }}/25-masquerade-nat-rules.sh'

- name: Create dir for haproxy
  when: haproxy_enabled
  tags:
    - haproxy
  ansible.builtin.raw: mkdir -p {{ unifi_mount_path }}/haproxy

- name: Template haproxy config
  when: haproxy_enabled
  tags:
    - haproxy
  ansible.builtin.raw: 'echo "{{ lookup(''template'', ''haproxy.cfg.j2'') }}" > {{ unifi_mount_path }}/haproxy/haproxy.cfg && chmod 755 {{ unifi_mount_path }}/haproxy/haproxy.cfg'

- name: Onboot - enasure executable flag is set on scripts
  ansible.builtin.raw: chmod +x {{ unifi_onboot_directory }}/*.sh
