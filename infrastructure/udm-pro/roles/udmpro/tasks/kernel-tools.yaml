---
- name: Kernel-tools - check kernel tools version
  register: kernel_tool_version
  ansible.builtin.raw: "{{ unifi_os_cmd }} dpkg-query --showformat='${Version}' --show udm-kernel-tools"

- name: Kernel-tools - installation
  when: kernel_tool_version is not defined or (kernel_tool_version.stdout != udm_kernel_tool_version)
  block:
    - name: Kernel-tools - download package
      ansible.builtin.raw: curl -L "{{ udm_kernel_tool_download_uri }}" -o "{{ unifi_mount_path }}/unifi-os/udm-kernel-tools_{{ udm_kernel_tool_version }}.deb"
    - name: Kernel-tools - install package
      ansible.builtin.raw: "{{ unifi_os_cmd }} dpkg -i {{ unifi_os_mount_path }}/udm-kernel-tools_{{ udm_kernel_tool_version }}.deb"

- name: Kernel-tools - fetch current kernel version
  block:
    - name: Kernel-tools - get current kernel version
      ansible.builtin.raw: "{{ unifi_os_cmd }} uname -r"
      register: current_kernel_version_raw

    - name: Kernel-tools - update fact current kernel version
      ansible.builtin.set_fact:
        current_kernel_version: "{{ current_kernel_version_raw.stdout_lines[0] }}"

- name: Kernel-tools - download latest kernel
  when: udm_kernel_tools_kernel_version is not defined
  block:
    - name: Kernel-tools - check latest udm-kernel
      ansible.builtin.uri:
        url: "{{ udm_kernel_release_url }}"
        return_content: true
      register: udm_kernel_latest_data

    - name: "Kernel-tools - download kernel {{ udm_kernel_latest_data.json.tag_name }}"
      loop: "{{ udm_kernel_latest_data.json.assets }}"
      when: "'udm-kernel' in item.name"
      no_log: true
      ansible.builtin.raw: curl -s -L "{{ item.browser_download_url }}" -o "{{ unifi_mount_path }}/unifi-os/{{ item.name }}"

    - name: Kernel-tools - set fact about downloaded kernel version
      loop: "{{ udm_kernel_latest_data.json.assets }}"
      when: "'udm-kernel' in item.name"
      no_log: true
      ansible.builtin.set_fact:
        downloaded_file: "{{ item.name }}"
        udm_kernel_tools_kernel_version: "{{ udm_kernel_latest_data.json.tag_name | regex_replace('^v(.*)', '\\1') }}"

    - name: Kernel-tools - install package
      when: current_kernel_version != udm_kernel_tools_kernel_version
      ansible.builtin.raw: "{{ unifi_os_cmd }} dpkg -i {{ unifi_os_mount_path }}/{{ downloaded_file }}"

- name: Kernel-tools - verify kernel version
  ansible.builtin.raw: "{{ unifi_os_cmd }} udm-bootctl list | awk '{print $1}' | tail -n +2"
  register: installed_kernel_versions

- name: "Kernel-tools - check if installed: {{ udm_kernel_tools_kernel_version }}"
  when: not udm_kernel_tools_kernel_version in installed_kernel_versions.stdout_lines
  ansible.builtin.fail:
    msg: "{{ udm_kernel_tools_kernel_version }} is not installed"

- name: Kernel-tools - set default kernel version
  when: current_kernel_version != udm_kernel_tools_kernel_version
  ansible.builtin.raw: "{{ unifi_os_cmd }} udm-bootctl set-default {{ udm_kernel_tools_kernel_version }}"

- name: Kernel-tools - ensure udm-autoboot is enabled
  when: udm_kernel_tools_autoboot
  ansible.builtin.raw: "{{ unifi_os_cmd }} systemctl enable udm-autoboot.service"

- name: "Kernel-tools - boost custom kernel {{ udm_kernel_latest_data.json.tag_name }}"
  when: current_kernel_version != udm_kernel_tools_kernel_version
  ansible.builtin.raw: "{{ unifi_os_cmd }} udm-bootctl boot {{ udm_kernel_tools_kernel_version }}"
