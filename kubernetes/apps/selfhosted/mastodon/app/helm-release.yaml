---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mastodon
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    controllers:
      sidekiq:
        annotations:
          reloader.stakater.com/auto: "true"

        containers:
          main:
            image:
              repository: ghcr.io/mastodon/mastodon
              tag: v4.4.3
            command: ["bundle", "exec", "sidekiq"]
            envFrom:
              - secretRef:
                  name: mastodon-secret
            env: &env
              LOCAL_DOMAIN: toot.selfy.social
              SMTP_FROM_ADDRESS: notifications@selfy.social
              SMTP_AUTH_METHOD: none
              SMTP_OPENSSL_VERIFY_MODE: none
              SMTP_ENABLE_STARTTLS: auto
              REDIS_HOST: dragonfly.databases.svc.cluster.local
              REDIS_PORT: 6379
              DB_HOST:
                valueFrom:
                  secretKeyRef:
                    name: database-mastodon-user
                    key: HOST
              DB_PORT: 5432
              DB_NAME:
                valueFrom:
                  secretKeyRef:
                    name: database-mastodon-user
                    key: DATABASE_NAME
              DB_USER:
                valueFrom:
                  secretKeyRef:
                    name: database-mastodon-user
                    key: LOGIN
              DB_PASS:
                valueFrom:
                  secretKeyRef:
                    name: database-mastodon-user
                    key: PASSWORD

            resources:
              limits:
                memory: 2048Mi
              requests:
                memory: 500Mi

      streaming:
        annotations:
          reloader.stakater.com/auto: "true"

        containers:
          main:
            image:
              repository: ghcr.io/mastodon/mastodon-streaming
              tag: v4.4.3
            command: ["node", "./streaming/index.js"]
            envFrom:
              - secretRef:
                  name: mastodon-secret
            env: *env

            resources:
              limits:
                memory: 2048Mi
              requests:
                memory: 500Mi

      web:
        annotations:
          reloader.stakater.com/auto: "true"

        containers:
          main:
            image:
              repository: ghcr.io/mastodon/mastodon
              tag: v4.4.3
            command: ["bundle", "exec", "puma", "-C", "config/puma.rb"]
            envFrom:
              - secretRef:
                  name: mastodon-secret
            env: *env

            resources:
              limits:
                memory: 2048Mi
              requests:
                memory: 500Mi

        pod:
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchLabels:
                      app.kubernetes.io/name: mastodon
                      app.kubernetes.io/instance: mastodon
                      app.kubernetes.io/controller: sidekiq
                  topologyKey: kubernetes.io/hostname

      cronjob:
        type: cronjob
        cronjob:
          schedule: "0 4 * * *"
          parallelism: 1
          successfulJobsHistory: 1
          failedJobsHistory: 1

        containers:
          main:
            image:
              repository: ghcr.io/mastodon/mastodon
              tag: v4.4.3
            command: ["tootctl", "media", "remove", "--days=7"]
            envFrom:
              - secretRef:
                  name: mastodon-secret
            env: *env

            resources:
              limits:
                memory: 2048Mi
              requests:
                memory: 500Mi
        pod:
          securityContext:
            runAsUser: 1001
            runAsGroup: 1001
            fsGroup: 1001
            fsGroupChangePolicy: "OnRootMismatch"
            supplementalGroups:
              - 65539
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchLabels:
                      app.kubernetes.io/name: mastodon
                      app.kubernetes.io/instance: mastodon
                      app.kubernetes.io/controller: sidekiq
                  topologyKey: kubernetes.io/hostname

    service:
      streaming:
        controller: streaming
        ports:
          http:
            port: &streamingPort 4000
      web:
        controller: web
        ports:
          http:
            port: &webPort 3000

    persistence:
      data:
        type: persistentVolumeClaim
        existingClaim: mastodon
        advancedMounts:
          sidekiq:
            main:
              - path: /mastodon/public/system
          web:
            main:
              - path: /mastodon/public/system
          cronjob:
            main:
              - path: /mastodon/public/system

    route:
      app:
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/description: Social media platform
          gethomepage.dev/group: Social
          gethomepage.dev/icon: sh-mastodon.svg
          gethomepage.dev/name: Mastodon
          gethomepage.dev/app: mastodon
        hostnames: ["toot.selfy.social"]
        parentRefs:
          - name: social
            namespace: kube-system
            sectionName: https
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /api/v1/streaming
            backendRefs:
              - name: mastodon-streaming
                port: *streamingPort
            filters:
              - type: RequestHeaderModifier
                requestHeaderModifier:
                  set:
                    - name: X-Forwarded-Proto
                      value: https
          - backendRefs:
              - name: mastodon-web
                port: *webPort
