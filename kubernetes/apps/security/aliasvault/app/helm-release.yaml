apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app aliasvault
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
  values:
    controllers:
      client:
        containers:
          main:
            image:
              repository: ghcr.io/aliasvault/client
              tag: 0.23.2

            env: &envs
              POSTGRES_HOST:
                valueFrom:
                  secretKeyRef:
                    name: database-aliasvault-user
                    key: HOST
              POSTGRES_DATABASE:
                valueFrom:
                  secretKeyRef:
                    name: database-aliasvault-user
                    key: DATABASE_NAME
              POSTGRES_USER:
                valueFrom:
                  secretKeyRef:
                    name: database-aliasvault-user
                    key: ROLE

              PUBLIC_REGISTRATION_ENABLED: false
              SMTP_PORT: &smtpPort 25
              SMTP_TLS_ENABLED: false
              SMTP_TLS_PORT: &smtpTlsPort 587
              # Example: PRIVATE_EMAIL_DOMAINS=example.com,example2.org
              PRIVATE_EMAIL_DOMAINS: aliase.se

            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                memory: 256Mi

      api:
        containers:
          main:
            image:
              repository: ghcr.io/aliasvault/api
              tag: 0.23.2

            env: *envs

            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                memory: 256Mi

      admin:
        pod:
          affinity:
            podAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchLabels:
                      app.kubernetes.io/name: aliasvault
                      app.kubernetes.io/instance: aliasvault
                      app.kubernetes.io/controller: api
                  topologyKey: kubernetes.io/hostname
        containers:
          main:
            image:
              repository: ghcr.io/aliasvault/admin
              tag: 0.23.2

            env: *envs

            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                memory: 256Mi

      smtp:
        containers:
          main:
            image:
              repository: ghcr.io/aliasvault/smtp
              tag: 0.23.2

            env: *envs

            resources:
              requests:
                cpu: 100m
                memory: 128Mi
              limits:
                memory: 256Mi

      taskRunner:
        containers:
          main:
            image:
              repository: ghcr.io/aliasvault/task-runner
              tag: 0.23.2

            env: *envs

            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                memory: 512Mi

    service:
      client:
        controller: client
        ports:
          http:
            port: &clientPort 3000
      api:
        controller: api
        ports:
          http:
            port: &apiPort 3001
      admin:
        controller: admin
        ports:
          http:
            port: &adminPort 3002
      smtp:
        controller: smtp
        type: LoadBalancer
        annotations:
          lbipam.cilium.io/ips: 192.168.20.203
        ports:
          smtp:
            port: *smtpPort
          smtp-tls:
            port: *smtpTlsPort

    route:
      client:
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/description: Password and alias manager
          gethomepage.dev/group: Security
          gethomepage.dev/icon: sh-aliasvault.svg
          gethomepage.dev/name: AliasVault
          gethomepage.dev/app: aliasvault
        hostnames: ["{{ .Release.Name }}.hemma.dev"]
        parentRefs:
          - name: internal
            namespace: networking
            sectionName: https
        rules:
          - backendRefs:
              - identifier: admin
                port: *adminPort
            matches:
              - path:
                  type: PathPrefix
                  value: /admin
          - backendRefs:
              - identifier: api
                port: *apiPort
            matches:
              - path:
                  type: PathPrefix
                  value: /api
          - backendRefs:
              - identifier: client
                port: *clientPort

    persistence:
      logs:
        enabled: true
        type: emptyDir
        globalMounts:
          - path: /logs

      app-certs:
        enabled: true
        existingClaim: aliasvault-data
        advancedMounts:
          admin:
            main:
              - path: /certificates/app
          api:
            main:
              - path: /certificates/app

      config:
        type: secret
        name: aliasvault
        globalMounts:
          - path: /secrets/admin_password_hash
            subPath: admin_password_hash
            readOnly: true
          - path: /secrets/data_protection_cert_pass
            subPath: data_protection_cert_pass
            readOnly: true
          - path: /secrets/jwt_key
            subPath: jwt_key
            readOnly: true

      pgpw:
        type: secret
        name: database-aliasvault-user
        globalMounts:
          - path: /secrets/postgres_password
            subPath: PASSWORD
            readOnly: true
