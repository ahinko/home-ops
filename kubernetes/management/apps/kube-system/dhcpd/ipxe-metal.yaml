---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ipxe-metal
  namespace: kube-system
data:
  ipxe-metal.conf: |
    allow bootp;
    allow booting;

    # Option 66
    option tftp-server-name "${SIDERO_ENDPOINT}";

    # IP address for PXE-based TFTP methods
    next-server ${SIDERO_ENDPOINT};

    # Configuration for iPXE clients
    class "ipxeclient" {
      match if exists user-class and (option user-class = "iPXE");
      # if arm64
      if option client-system-arch = 00:0b {
        filename "http://${SIDERO_ENDPOINT}:8081/boot-arm64.ipxe";
      } else {
        filename "http://${SIDERO_ENDPOINT}:8081/boot.ipxe";
      }
    }

    # Configuration for legacy BIOS-based PXE boot
    class "biosclients" {
      match if not exists user-class and substring (option vendor-class-identifier, 15, 5) = "00000";
      filename "undionly.kpxe";
    }

    # Configuration for UEFI-based PXE boot
    class "pxeclients" {
      match if not exists user-class and substring (option vendor-class-identifier, 0, 9) = "PXEClient";
      # if arm64
      if option client-system-arch = 00:0b {
        filename "ipxe-arm64.efi";
      } else {
        filename "ipxe.efi";
      }
    }

    # Configuration for UEFI-based HTTP boot
    class "httpclients" {
      match if not exists user-class and substring (option vendor-class-identifier, 0, 10) = "HTTPClient";
      option vendor-class-identifier "HTTPClient";
      #if arm64
      if option client-system-arch = 00:0b {
        filename "http://${SIDERO_ENDPOINT}:8081/tftp/ipxe-arm64.efi";
      } else {
        filename "http://${SIDERO_ENDPOINT}:8081/tftp/ipxe.efi";
      }
    }
