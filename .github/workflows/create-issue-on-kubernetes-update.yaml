---
name: Create issue when Kubernetes update is available

on:
  push:
    branches:
      - main
    paths:
      - "infrastructure/talos/talconfig.yaml"
      - "infrastructure/talos/upgrade-k8s.sh"

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  check-for-kubernetes-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Token
        uses: tibdex/github-app-token@v1.7.0
        id: generate-token
        with:
          app_id: ${{ secrets.HOMEOPS_BOT_APP_ID }}
          private_key: ${{ secrets.HOMEOPS_BOT_PRIVATE_KEY }}

      - name: Create issue if new version of Kubernetes is available
        if: contains(github.event.head_commit.message, 'update image ghcr.io/siderolabs/kubelet')
        uses: dacbd/create-issue-action@v1.2.1
        with:
          token: "${{ steps.generate-token.outputs.token }}"
          title: "ðŸš€ Upgrade Kubernetes"
          body: |
            A new version of Kubernetes has been merged in to the main branch. Please run the upgrade command after you have checked that each app on the cluster supports the new version, (mainly databases and rook).
          assignees: ahinko
